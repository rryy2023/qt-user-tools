# 多平台打包问题解决方案

## 当前问题分析

### 1. macOS Intel (x86_64) 打包失败

**错误信息：**
```
IncompatibleBinaryArchError: _cffi_backend.cpython-310-darwin.so is incompatible with target arch x86_64 (has arch: arm64)
```

**原因：**
- 系统是 Apple Silicon (arm64)
- Python 依赖包是 ARM64 架构
- 无法在 x86_64 打包中使用 ARM64 依赖

**解决方案：**

#### 方案 A：安装 x86_64 版本的依赖（推荐）

```bash
# 使用 Rosetta 2 安装 x86_64 版本的依赖
arch -x86_64 python3 -m pip install --force-reinstall --no-deps PyQt6 PyQt6-Qt6 beautifulsoup4 lxml requests netifaces pyinstaller

# 或者创建独立的 x86_64 Python 环境
arch -x86_64 python3 -m venv venv_x86_64
source venv_x86_64/bin/activate
pip install -r requirements.txt
```

#### 方案 B：在 Intel Mac 上打包（如果有）

直接在 Intel Mac 上运行脚本，依赖会自动匹配。

#### 方案 C：跳过 Intel 版本（如果不需要）

只打包 ARM64 版本：
```bash
./build_all_platforms.sh --mac-arm64
```

### 2. macOS ARM64 打包

虽然显示成功，但建议验证：

```bash
# 检查生成的 app 架构
file dist/mac_arm64/千图网问题解决工具.app/Contents/MacOS/千图网问题解决工具

# 应该显示：Mach-O 64-bit executable arm64
```

### 3. Windows 打包

**问题：** Wine 未安装

**解决方案：**

#### 方案 A：安装 Wine（实验性，不推荐）

```bash
# macOS 上安装 Wine
brew install --cask wine-stable

# 注意：Wine 在 macOS 上打包 Windows 应用可能不稳定
```

#### 方案 B：在 Windows 系统上打包（推荐）

在 Windows 系统上运行：
```batch
build_windows.bat
```

## 推荐的打包策略

### 对于 Apple Silicon Mac：

1. **只打包 ARM64 版本**（最简单）
   ```bash
   ./build_all_platforms.sh --mac-arm64
   ```

2. **如果需要 Intel 版本**：
   - 安装 x86_64 版本的 Python 和依赖
   - 或使用 CI/CD 在 Intel Mac 上构建

3. **Windows 版本**：
   - 在 Windows 系统上打包
   - 或使用 GitHub Actions 等 CI 服务

## 快速修复脚本

创建 `fix_x86_64_deps.sh`：

```bash
#!/bin/bash
# 为 x86_64 打包安装依赖

echo "安装 x86_64 版本的依赖..."

# 使用 Rosetta 2 安装
arch -x86_64 python3 -m pip install --force-reinstall \
    PyQt6 PyQt6-Qt6 \
    beautifulsoup4 \
    lxml \
    requests \
    netifaces \
    pyinstaller \
    --target /tmp/pyinstaller_x86_64

echo "完成！"
```

## 验证架构

```bash
# 检查 Python 架构
python3 -c "import platform; print(platform.machine())"

# 检查依赖包架构
file $(python3 -c "import _cffi_backend; print(_cffi_backend.__file__)")

# 检查生成的 app 架构
file dist/mac_arm64/千图网问题解决工具.app/Contents/MacOS/千图网问题解决工具
```
