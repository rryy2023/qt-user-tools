# 启动性能优化 v2

## 🐛 问题

Mac 打开应用时：
- 窗口一闪
- 等待十几秒才真正打开应用

## 🔍 原因分析

### 耗时操作

1. **UI 组件创建**（主要耗时）
   - 8 个问题卡片（`ProblemCard`）
   - 6 个工具按钮
   - 状态栏组件
   - 每个组件都需要应用样式表

2. **样式表加载**
   - 读取 `styles.qss` 文件
   - 解析和应用样式

3. **状态检查**
   - 系统信息检查
   - 权限检查
   - hosts 文件检查（已异步，但可能仍有影响）

## ✅ 优化方案

### 1. 延迟创建问题卡片

**之前**：在 `init_ui()` 中同步创建所有卡片

**现在**：延迟 50ms 创建，让窗口先显示

```python
# 先添加布局
main_layout.addLayout(cards_layout)

# 延迟创建卡片
QTimer.singleShot(50, lambda: self._create_problem_cards(cards_layout))
```

### 2. 延迟加载样式表

**之前**：在创建窗口前加载样式表

**现在**：窗口显示后 100ms 加载

```python
# 创建窗口
main_window = MainWindow()

# 延迟加载样式表
QTimer.singleShot(100, load_stylesheet)
```

### 3. 进一步延迟状态更新

**之前**：
- 快速更新：50ms
- 异步更新：500ms

**现在**：
- 快速更新：200ms
- 异步更新：1500ms

### 4. 优化窗口显示时机

**之前**：窗口在 `__init__` 完成后立即显示

**现在**：
- 立即初始化 UI（但卡片延迟创建）
- 立即显示窗口
- 处理事件循环，确保窗口能立即显示

```python
# 立即显示主窗口
main_window.show()

# 处理事件循环，确保窗口能立即显示
app.processEvents()
```

## 📋 优化效果

### 启动流程

1. **0ms**：创建应用和窗口
2. **0ms**：显示窗口（此时可能只有框架）
3. **50ms**：创建问题卡片
4. **100ms**：加载样式表
5. **200ms**：快速状态更新
6. **1500ms**：异步 hosts 检查

### 用户体验

- ✅ 窗口立即显示（不再闪烁）
- ✅ 内容逐步加载（渐进式）
- ✅ 非关键操作延后（不阻塞启动）

## 🚀 进一步优化建议

如果仍有性能问题，可以考虑：

1. **懒加载工具按钮**：只在用户点击工具箱时创建
2. **缓存样式表**：避免每次启动都读取文件
3. **预编译样式**：将 QSS 转换为 Python 代码
4. **减少组件数量**：合并或简化某些组件

## 📝 相关文件

- `gui/main.py` - 应用入口，延迟加载样式表
- `gui/main_window.py` - 主窗口，延迟创建卡片和状态更新
- `gui/widgets/problem_card.py` - 问题卡片组件
